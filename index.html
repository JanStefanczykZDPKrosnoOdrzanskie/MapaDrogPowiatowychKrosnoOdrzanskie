<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa ZDP</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>

body{
margin:0;
padding:0;
}

#map{
position:absolute;
top:0;
bottom:0;
width:100%;
}

#legend{
position:absolute;
top:10px;
left:10px;
z-index:10;
background:white;
padding:10px;
border-radius:5px;
box-shadow:0 0 5px rgba(0,0,0,0.3);
font-family:Arial,sans-serif;
font-size:14px;
}

.legend-line{
display:inline-block;
width:40px;
height:3px;
margin-right:5px;
vertical-align:middle;
}

</style>

</head>

<body>

<div id="legend">
<h3>Legenda</h3>

<label>
<input type="checkbox" data-layers="layer_adm_1" checked>
<span class="legend-line" style="background:#FF0000"></span>
Droga Krajowa
</label><br>

<label>
<input type="checkbox" data-layers="layer_adm_2" checked>
<span class="legend-line" style="background:#08FF00"></span>
Droga Wojewewódzkie
</label><br>

<label>
<input type="checkbox" data-layers="layer_adm_3" checked>
<span class="legend-line" style="background:#A500AD"></span>
Droga Powiatowa
</label><br>

<label>
<input type="checkbox" data-layers="layer_zud_2" checked>
<span class="legend-line" style="background:#FFEE00"></span>
Standard 2
</label><br>

<label>
<input type="checkbox" data-layers="layer_zud_3" checked>
<span class="legend-line" style="background:#00FFFF"></span>
Standard 3
</label><br>

<label>
<input type="checkbox" data-layers="layer_zud_4" checked>
<span class="legend-line" style="background:#FA9EFF"></span>
ZUD = 4
</label><br>

<label>
<input type="checkbox" data-layers="layer_zud_6" checked>
<span class="legend-line" style="background:#A1A1A1"></span>
ZUD = 6
</label>

</div>

<div id="map"></div>

<script>

/* ===============================
MAP INSTANCE
=============================== */

window.map_instance = new maplibregl.Map({

container:'map',

style:{
version:8,

glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",

sources:{
osm:{
type:"raster",
tiles:[
"https://tile.openstreetmap.org/{z}/{x}/{y}.png"
],
tileSize:256,
attribution:"© OpenStreetMap contributors"
}
},

layers:[
{
id:"osm",
type:"raster",
source:"osm"
}
]

},

center:[14.8953712,52.01625],
zoom:10

});
/* ===============================
GEOJSON SOURCE LOADER
=============================== */

async function ZDP_LOAD_GEO_SOURCES(map){
try{

const [roads_main, roads_dp] = await Promise.all([
    fetch("DK_i_DW.geojson").then(r=>r.json()),
    fetch("DP.geojson").then(r=>r.json())
]);

const merged_roads = {
    type: "FeatureCollection",
    features: [
        ...(roads_main?.features || []),
        ...(roads_dp?.features || [])
    ]
};

if(map.getSource("zdp_roads")){
    map.removeSource("zdp_roads");
}

map.addSource("zdp_roads",{
    type:"geojson",
    data: merged_roads
});

console.log("GeoJSON merged source loaded");

}catch(e){
console.error(e);
}
}

/* ===============================
ROAD LAYER FACTORY
=============================== */

function ADD_FILTER_LAYER(map, layerId, source, filterExpression, color){

if(map.getLayer(layerId)) return;

map.addLayer({
id:layerId,
type:"line",
source:source,

filter:filterExpression,

paint:{
"line-color":color,
"line-width":3
}
});

}

/* ===============================
ROAD RENDERER
=============================== */

function ZDP_RENDER_ROAD_STYLES(map){

ADD_FILTER_LAYER(map,"layer_adm_1","zdp_roads",["==",["get","Adm"],1],"#FF0000");

ADD_FILTER_LAYER(map,"layer_adm_2","zdp_roads",["==",["get","Adm"],2],"#08FF00");

ADD_FILTER_LAYER(map,"layer_adm_3","zdp_roads",["==",["get","Adm"],3],"#A500AD");

ADD_FILTER_LAYER(map,"layer_zud_2","zdp_roads",["==",["get","ZUD"],2],"#FFEE00");

ADD_FILTER_LAYER(map,"layer_zud_3","zdp_roads",["==",["get","ZUD"],3],"#00FFFF");

ADD_FILTER_LAYER(map,"layer_zud_4","zdp_roads",["==",["get","ZUD"],4],"#FA9EFF");

ADD_FILTER_LAYER(map,"layer_zud_6","zdp_roads",["==",["get","ZUD"],6],"#A1A1A1");
}

/* ===============================
LABEL LAYER
=============================== */
function ADD_LABEL_LAYER(map){

if(map.getLayer("road_id_labels")) return;

map.addLayer({
    id:"road_id_labels",
    type:"symbol",
    source:"zdp_roads",

    layout:{
        "symbol-placement":"line",
        "text-field":["get","ID"],
        "text-size":12,
        "text-anchor":"center",
        "text-allow-overlap":false,
        "text-ignore-placement":false
    },

"paint":{

/* ===============================
TEXT COLOR
=============================== */

"text-color":[
    "case",

    // DK → biały tekst
    ["==", ["get","Adm"], 1],
    "#FFFFFF",

    // DW → czarny tekst
    ["==", ["get","Adm"], 2],
    "#000000",

    // DP → biały tekst
    ["==", ["get","Adm"], 3],
    "#FFFFFF",

    "#000000"
],

/* ===============================
HALO = RAMKA WOKÓŁ TEKSTU
=============================== */

"text-halo-color":[
    "case",

    // DK → czerwone tło
    ["==", ["get","Adm"], 1],
    "#FF0000",

    // DW → żółte tło
    ["==", ["get","Adm"], 2],
    "#FFEE00",

    // DP → fioletowe tło
    ["==", ["get","Adm"], 3],
    "#A500AD",

    "#FFFFFF"
],

"text-halo-width":3

}

});

}

/* ===============================
LEGEND CONTROL
=============================== */

function ZDP_LEGEND_INIT(){

document.querySelectorAll('#legend input').forEach(chk=>{

chk.addEventListener('change',e=>{

const map = window.map_instance;
if(!map) return;

const layers = e.target.dataset.layers.split(',');

layers.forEach(layerId=>{

if(!map.getLayer(layerId)) return;

map.setLayoutProperty(
layerId,
'visibility',
e.target.checked ? 'visible':'none'
);

});

});

});

console.log("Legend controller initialized");
}

/* ===============================
PIPELINE LOAD
=============================== */

window.map_instance.on('load', async()=>{

const map = window.map_instance;

/* Source */
await ZDP_LOAD_GEO_SOURCES(map);

/* Layers */
ZDP_RENDER_ROAD_STYLES(map);

/* Labels */
ADD_LABEL_LAYER(map);

/* Legend */
ZDP_LEGEND_INIT();

});

</script>

</body>
</html>






